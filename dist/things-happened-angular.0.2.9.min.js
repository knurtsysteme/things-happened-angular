/*! things-happened-angular v0.2.9 | (c) 2013-2014 KNURT Systeme | MIT License */
"use strict";/*! things-happened-util v0.3.0 | (c) 2013-2014 KNURT Systeme | MIT License */
var ThingsDate={};ThingsDate.getDate=function(a,b){b=b||"_date";var c=a[b],d=c.length>3?c.substr(0,4)-0:0,e=c.length>5?c.substr(4,2)-1:0,f=c.length>7?c.substr(6,2)-0:0,g=c.length>9?c.substr(8,2)-0:0,h=c.length>11?c.substr(10,2)-0:0,i=c.length>13?c.substr(12,2)-0:0;return new Date(d,e,f,g,h,i)};var ThingsForest=function(a){var b={},c=function(a,b){for(var c=[],d=a.length;d--;)"undefined"!=typeof a[d][b]&&c.push(a[d][b]);return c},d=function(b){return b=b||a,c(b,"_rid")};return b.containsTree=function(a){return d().indexOf(a._rid)>=0},b.without=function(b){"undefined"!=typeof b._rid&&(b=[b]);for(var c=[],e=d(b),f=a.length;f--;)e.indexOf(a[f]._rid)<0&&c.push(a[f]);return c},b.getLatest=function(b){b=b||"_date";for(var c=!1,d=a.length;d--;)if(a[d][b]){for(var e=a[d][b];1e13>e;)e*=10;(!c||e>c[b])&&(c=a[d])}return c},b},ThingsQuery={};ThingsQuery._produce=function(a,b){var b=b||{};b.action=b.action||"get",b.criteria=b.criteria||{};var c=this;if(a=a||"things","string"!=typeof a||!a.match(/^[a-z]+$/))throw new Error('must have "things" (@see mongo\'s collection name)');this.thatHaveNoChildIn=function(a){return this.whose("_id").isNotIn(a,"_pid")},this.thatAreRoot=function(){return this.whose("_pid").is(null)},this.thatHaveAChildIn=function(a){return this.whose("_id").isIn(a,"_pid")},this.inSameForestAs=function(a){return this.whose("_rid").isIn(a,"_rid")},this.inSameTreeAs=function(a){return this.whose("_rid").is(a._rid)},this.branchOf=function(a){for(var b=a._branch||"0",c=["0"];b.length>1;)c.push(b),b=b.substr(0,b.lastIndexOf(","));return this.inSameTreeAs(a).whose("_branch").isIn(c)},this.that=function(a){if("string"!=typeof a||!a.match(/^[a-z\-]+$/))throw new Error('must have "things" (@see mongo\'s collection name)');return b.happened=a,c},this.hasCriterion=function(a){return"undefined"!=typeof b.criteria[a]},this.setSecret=function(a){return b.criteria._secret=a,c},this.inSameTreeAs=function(a){var d=a;return a&&"object"==typeof a&&a._rid&&(d=a._rid),b.criteria._rid=d,c},this.whoseDateIsBetween=function(a,b,c,d){return c=c||"_date",d=d||"_date",this.whose(c).isGreaterOrEqualThan(a).whose(d).isLowerThan(b)},this.whose=function(a){var d={},e=function(c,d,e){if(d){var f=[];b.criteria[a]&&b.criteria[a][e]&&(f=b.criteria[a][e]);for(var g=0;g<c.length;g++){var h=c[g][d];h&&f.indexOf(h)<0&&f.push(h)}c=f}var i={};return i[e]=c,i};return d.isIn=function(d,f){return b.criteria[a]=e(d,f,"$in"),c},d.isGreaterThan=function(d,f){return b.criteria[a]=e(d,f,"$gt"),c},d.isLowerThan=function(d,f){return b.criteria[a]=e(d,f,"$lt"),c},d.isGreaterOrEqualThan=function(d,f){return b.criteria[a]=e(d,f,"$gte"),c},d.isLowerOrEqualThan=function(d,f){return b.criteria[a]=e(d,f,"$lte"),c},d.exists=function(){return b.criteria[a]={$exists:!0},c},d.isNotIn=function(d,f){return b.criteria[a]=e(d,f,"$nin"),c},d.is=function(d){return b.criteria[a]=d,c},d},this.count=function(){return b.action="count",c},this.url=function(){var c=b.happened?"/"+b.happened:"",d=JSON.stringify(b.criteria);return d="{}"==d?"":"?criteria="+d,"/"+b.action+"/"+a+c+".json"+d}},ThingsQuery.select=function(a){return new ThingsQuery._produce(a,{action:"get"})},ThingsQuery.count=function(a){return new ThingsQuery._produce(a,{action:"count"})},ThingsQuery.getCopyForUpdate=function(a){for(var b={},c=Object.keys(a),d=c.length;--d;)c[d].match(/^_/)&&(b[c[d]]=a[c[d]]);return b};var ThingsConfig=ThingsConfig||{};ThingsConfig.serviceurl=ThingsConfig.serviceurl||"http://localhost:3000",ThingsConfig.secret=ThingsConfig.secret||!1,angular.module("thingsHappened",[]),angular.module("thingsHappened").factory("ThingsDao",["$http",function(a){var b={};return b.serviceurl=ThingsConfig.serviceurl.replace(/\/$/,""),b.get=function(c,d,e){"object"==typeof c&&(c=c[0]+"/"+c[1]);var f=b.serviceurl+"/get/"+c+".json";return d&&0==d._secret?delete d._secret:ThingsConfig.secret&&(d=d||{},d._secret="undefined"==typeof d._secret?ThingsConfig.secret:d._secret),d&&"{}"!=JSON.stringify(d)&&(f+="?criteria="+JSON.stringify(d)),e&&(f+=d?"&":"?",f+="projection="+JSON.stringify(e)),a.get(f)},b.query=function(c){return ThingsConfig.secret&&!c.hasCriterion("_secret")&&c.setSecret(ThingsConfig.secret),a.get(b.serviceurl+c.url())},b.getCountOfThings=function(){return a.get(b.serviceurl+"/count/things.json")},b.getHappenedTo=function(c){return a.get(b.serviceurl+"/get/happened/to/"+c+".json")},b.getCountOf=function(c,d){return a.get(d?b.serviceurl+"/count/"+c+"/"+d+".json":b.serviceurl+"/count/"+c+".json")},b.add=function(c){return{to:function(d,e){var f=b.serviceurl+"/addto/"+d+"/"+e+".json";return ThingsConfig.secret&&(c._secret=ThingsConfig.secret),a.post(f,c)}}},b}]),angular.module("thingsHappened").directive("thingsAddto",["$compile","ThingsDao",function(a,b){var c=function(a,b,c,d,e,f){return e=e||function(a){window.alert("Your new document stored: "+JSON.stringify(a))},f=f||function(){window.alert("YES! ... an error occured :(")},function(){return c.add(this[d]).to(a,b).success(e).error(f),!1}},d=1,e=function(){return"things"+d++},f={compile:function(){return{post:function(d,f,g){var h=g.thingsAddto,i=h.match(/^\s*([a-z]+)\s+([a-z]+)(.*)$/);if(i){var j=i[1],k=i[2],l=g.thingsSuccess||!1;l&&(l=d[l]);var m=g.thingsError||!1;m&&(m=d[m]);var n=e(),o=n+"Function";d[n]={},d[o]=c(j,k,b,n,l,m);var p=f.clone().wrap("<div />").parent().html();p=p.replace(/name\s*=\s*"/g,'ng-model="'+n+"."),p=p.replace(/name\s*=\s*'/g,"ng-model='"+n+"."),f.html(p),f.attr("ng-model",n),f.attr("ng-submit",o+"()"),f.removeAttr("things-addto"),a(f)(d)}}}}};return f}]),angular.module("thingsHappened").directive("thingsCount",["ThingsDao",function(a){return{scope:{thingsCount:"=",thingsHappened:"="},link:function(b,c){var d=function(){if(b.thingsCount){var d=null;d=b.thingsHappened?a.getCountOf(b.thingsCount,b.thingsHappened):a.getCountOf(b.thingsCount),d.success(function(a){c.text(a.result)})}else a.getCountOfThings().success(function(a){c.text(a._total)})};b.$watch(function(){return b.thingsCount+b.thingsHappened},d)}}}]),angular.module("thingsHappened").directive("thingsRepeat",["$compile","ThingsDao",function(a,b){var c=function(c,d){var e=d.clone();d.css("display","none");var f=function(){var f=c.thingsRepeat.match(/^\s*([\s\S]+?)\s+in\s+([a-z]+)(.*)$/);if(f){var g=f[2],h=e.clone().wrap("<div />").parent().html();d.parent().html(d),b.get(g,c.thingsCriteria,c.thingsProjection).success(function(b){c[g]=b;var e=angular.element(h);e.attr("ng-repeat",c.thingsRepeat),e.removeAttr("things-repeat"),a(e)(c),d.after(e)})}};c.$watch(function(){return c.thingsRepeat+angular.toJson(c.thingsCriteria)+c.thingsProjection},f)};return{replace:!0,restrict:"A",scope:{thingsRepeat:"@",thingsCriteria:"=",thingsProjection:"="},compile:function(){return{post:c}}}}]),angular.module("thingsHappened").directive("thingsTimeframe",function(){return{template:"<div></div>",restrict:"A",link:function(a,b){b.text("this is the thingsTimeframe directive")}}});